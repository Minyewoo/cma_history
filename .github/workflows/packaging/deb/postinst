#!/bin/bash
# 
# Deb package postinst script for API Server
#
############ CONFIGURATION SECTION ############
#
# Standart user, pass, database name for History service
#
user="crane_data_server"
pass="00d0-25e4-*&s2-ccds"
db="crane_data_server"
#
############ LIST OF SQL SCRIPTS TO BE EXECUTED ############
# list of SQL scripts to be executed in the format:
# 	[database] <path to sql script> <description>
read -r -d '' scripts << EOF
    "" "./sql/create_user.sql" "Creating Hystory database user '$user'..."
    "" "./sql/create_db.sql" "Creating Hystory database '$db'..."
    "" "./sql/create_grant_user.sql" "Creating Hystory database '$db'..."
    "$db" "./sql/create_tags.sql" "Creating 'tags' table..."
    "$db" "./sql/create_event.sql" "Creating 'event' table..."
    "$db" "./sql/create_event_view.sql" 
EOF

############ INSTALLATION ACTIONS ############
RED='\033[0;31m'
BLUE='\033[0;34m'
GRAY='\033[1;30m'
NC='\033[0m' # No Color
############ LOAD TO DB VIA PSQL ############
regex='\"([^\"]*?)\"[ \t]+\"([^\"]+?)\"([ \t]+\"([^\"]+?)\")?'
while IFS= read -r row; do
    [[ $row =~ $regex ]]
    connect=${BASH_REMATCH[1]:=""}
    path=${BASH_REMATCH[2]:="${RED}not specified${NC}"}
    description=${BASH_REMATCH[4]:="Unnamed SQL script..."}
    echo ""
    echo -e "c0: $c0"
    echo -e "$description"
    echo -e "\t${GRAY}from file:${NC} $path"
    echo -e "\t${GRAY}connect to database:${NC} $connect"
    source "$path"
    echo -e "\t${GRAY}SQL:${NC}"
    # echo -e "\t${GRAY}$sql${NC}"
    if [ -z "$connect" ]; then
        echo $sql | sudo -i -u postgres psql --echo-errors
    else
        echo $sql | sudo -i -u postgres psql --echo-errors --dbname=$connect
    fi
done <<< "$scripts"
